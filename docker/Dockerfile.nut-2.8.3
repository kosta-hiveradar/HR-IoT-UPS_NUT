# Multi-arch NUT 2.8.4 build for Raspberry Pi ARM64 - Ubuntu Noble base
FROM ubuntu:noble AS builder

# Build arguments for cross-compilation
ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG TARGETOS
ARG TARGETARCH

ENV NUT_VERSION=2.8.4
ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies (Ubuntu has better ARM64 emulation support)
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libusb-1.0-0-dev \
    wget \
    ca-certificates \
    autoconf \
    automake \
    libtool \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Download and build NUT 2.8.4 (latest stable version)
WORKDIR /tmp
RUN wget https://github.com/networkupstools/nut/releases/download/v${NUT_VERSION}/nut-${NUT_VERSION}.tar.gz && \
    tar xfz nut-${NUT_VERSION}.tar.gz && \
    cd nut-${NUT_VERSION} && \
    ./configure \
        --prefix=/opt/nut \
        --sysconfdir=/opt/nut/etc \
        --with-user=nut \
        --with-group=nut \
        --with-usb=yes \
        --with-nut-scanner=yes \
        --with-nutclient=yes \
        --with-dev \
        --enable-strip \
        --disable-static \
        --without-cgi \
        --without-snmp \
        --without-neon \
        --without-ssl \
        --datadir=/opt/nut/share \
        --with-drvpath=/opt/nut/lib/nut \
        --with-statepath=/var/run/nut && \
    make -j$(nproc) && \
    make install DESTDIR=/tmp/install && \
    rm -rf /tmp/nut-${NUT_VERSION} /tmp/nut-${NUT_VERSION}.tar.gz

# Runtime image for target platform  
FROM ubuntu:noble

ARG TARGETARCH
ENV DEBIAN_FRONTEND=noninteractive

# Install runtime dependencies (Ubuntu Noble has excellent Raspberry Pi support)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libusb-1.0-0 \
    usbutils \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Create nut user with proper USB permissions for Raspberry Pi
RUN groupadd -r nut && \
    useradd -r -g nut -d /var/run/nut -s /sbin/nologin nut && \
    usermod -a -G plugdev,dialout nut

# Copy NUT binaries from builder
COPY --from=builder /tmp/install/opt/nut/bin/upsc /opt/nut/bin/
COPY --from=builder /tmp/install/opt/nut/bin/nut-scanner /opt/nut/bin/
COPY --from=builder /tmp/install/opt/nut/sbin/upsd /opt/nut/sbin/
COPY --from=builder /tmp/install/opt/nut/sbin/upsmon /opt/nut/sbin/
COPY --from=builder /tmp/install/opt/nut/sbin/upsdrvctl /opt/nut/sbin/
COPY --from=builder /tmp/install/opt/nut/lib/ /opt/nut/lib/
COPY --from=builder /tmp/install/opt/nut/share/ /opt/nut/share/

# Create necessary directories with proper permissions
RUN mkdir -p /var/run/nut /opt/nut/etc /var/state/ups && \
    chown -R nut:nut /var/run/nut /opt/nut/etc /var/state/ups && \
    chmod 750 /var/run/nut /opt/nut/etc

# Copy entrypoint optimized for IoT/RPi
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copy standard NUT configuration files with auto-detection
COPY standard_configs/ /opt/nut/etc/
RUN chown nut:nut /opt/nut/etc/*.conf && chown nut:nut /opt/nut/etc/upsd.users

# Create directory for persistent configs (will be mounted)
RUN mkdir -p /opt/nut/etc-default && \
    cp -r /opt/nut/etc/* /opt/nut/etc-default/ && \
    chmod 644 /opt/nut/etc-default/*

# Set library path for cross-compiled binaries
ENV LD_LIBRARY_PATH=/opt/nut/lib
ENV PATH="/opt/nut/bin:/opt/nut/sbin:${PATH}"

# Expose NUT server port for IoT dashboard
EXPOSE 3493

# Add health check for container monitoring
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD /opt/nut/bin/upsc my-ups@localhost > /dev/null || exit 1

ENTRYPOINT ["/entrypoint.sh"]